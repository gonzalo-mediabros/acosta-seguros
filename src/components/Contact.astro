---
import styles from "./Contact.module.css";
import Icon from "./Icon.astro";
---

<section id="contacto" class={styles.contact}>
  <div class:list={[styles.container, "container"]}>
    <div class={styles.header}>
      <h2 class={styles.title}>Agenda tu Cita</h2>
      <p class={styles.description}>
        Completa el formulario o contáctame directamente. Estoy para ayudarte a
        encontrar la mejor protección.
      </p>
    </div>

    <div class={styles.mainWrapper}>
      <div class={styles.infoBox}>
        <h3 class={styles.infoTitle}>Información de Contacto</h3>
        <p class={styles.infoText}>
          Puedes contactarme por estos medios para una respuesta más rápida.
        </p>
        <div class={styles.infoList}>
          <div class={styles.infoItem}>
            <Icon name="call" class={styles.infoIcon} />
            <a href="tel:2291070520" class={styles.infoLink}>22.91.07.05.20</a>
          </div>
          <div class={styles.infoItem}>
            <Icon name="mail" class={styles.infoIcon} />
            <a
              href="mailto:ericka.acosta.gama@gmail.com"
              class={styles.infoLink}>ericka.acosta.gama@gmail.com</a
            >
          </div>
        </div>
      </div>

      <div class={styles.formWrapper}>
        <form
          id="contact-form"
          class={styles.form}
          data-url={import.meta.env.PUBLIC_SCRIPT_URL}
          data-apikey={import.meta.env.PUBLIC_SCRIPT_API_KEY}
        >
          <div class={styles.gridInputs}>
            <input
              type="text"
              name="name"
              placeholder="Nombre Completo"
              required
              class={styles.input}
            />
            <input
              type="tel"
              name="phone"
              placeholder="Teléfono"
              required
              class={styles.input}
            />
          </div>
          <div style="display: none;">
            <input
              type="text"
              name="website"
              tabindex="-1"
              autocomplete="off"
            />
          </div>
          <input
            type="email"
            name="email"
            placeholder="Email"
            required
            class={styles.input}
          />
          <select name="service" required class={styles.select}>
            <option value="">¿Qué servicio te interesa?</option>
            <option value="Fiscal">Asesoría Fiscal</option>
            <option value="Personal">Protección Personal</option>
            <option value="Patrimonial">Protección Patrimonial</option>
            <option value="Otro">Otro / Asesoría General</option>
          </select>
          <textarea
            name="message"
            placeholder="Mensaje breve (opcional)"
            rows="4"
            class={styles.textarea}></textarea>
          <div class={styles.btnWrapper}>
            <button type="submit" class={styles.submitBtn}>
              Enviar Mensaje
            </button>
          </div>
        </form>

        <!-- Success Message -->
        <div
          id="contact-success"
          class={styles.feedbackContainer}
          style="display: none;"
        >
          <div class={styles.successIconWrapper}>
            <Icon name="check" class={styles.feedbackIcon} />
          </div>
          <h3 class={styles.feedbackTitle}>¡Gracias!</h3>
          <p class={styles.feedbackText}>
            Recibimos tu consulta con éxito. Un especialista se pondrá en
            contacto contigo pronto.
          </p>
          <button type="button" class={styles.resetBtn} id="form-reset-success">
            Enviar otra consulta
          </button>
        </div>

        <!-- Error Message -->
        <div
          id="contact-error"
          class={styles.feedbackContainer}
          style="display: none;"
        >
          <div class={styles.errorIconWrapper}>
            <Icon name="error" class={styles.feedbackIcon} />
          </div>
          <h3 class={styles.feedbackTitle}>¡Ups!</h3>
          <p class={styles.feedbackText}>
            Hubo un problema al enviar tu mensaje. Por favor, inténtalo de nuevo
            o contáctanos directamente.
          </p>
          <button type="button" class={styles.resetBtn} id="form-reset-error">
            Reintentar
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById("contact-form") as HTMLFormElement;

  if (form) {
    const SCRIPT_URL = form.dataset.url;
    const API_KEY = form.dataset.apikey;

    form.addEventListener("submit", async (e: SubmitEvent) => {
      e.preventDefault();

      if (!SCRIPT_URL) {
        console.error("Script URL not found");
        return;
      }

      const submitBtn = form.querySelector(
        'button[type="submit"]',
      ) as HTMLButtonElement;

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerText = "Enviando...";
      }

      const formData = new FormData(form);
      const data: Record<string, any> = Object.fromEntries(formData.entries());

      // Metadata obligatoria
      data.pageUrl = window.location.href;
      data.api_key = API_KEY || "";

      try {
        // Usamos fetch con mode: 'no-cors' para Google Apps Script
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        // Éxito: Mostrar mensaje y ocultar form
        form.style.display = "none";
        const successEl = document.getElementById("contact-success");
        if (successEl) successEl.style.display = "flex";
        form.reset();
      } catch (error) {
        console.error("Error al enviar el formulario:", error);
        // Error: Mostrar mensaje y ocultar form
        form.style.display = "none";
        const errorEl = document.getElementById("contact-error");
        if (errorEl) errorEl.style.display = "flex";
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerText = "Enviar Mensaje";
        }
      }
    });

    // Reset logic
    const resetSuccess = document.getElementById("form-reset-success");
    const resetError = document.getElementById("form-reset-error");
    const successEl = document.getElementById("contact-success");
    const errorEl = document.getElementById("contact-error");

    [resetSuccess, resetError].forEach((btn) => {
      btn?.addEventListener("click", () => {
        if (successEl) successEl.style.display = "none";
        if (errorEl) errorEl.style.display = "none";
        form.style.display = "flex";
      });
    });
  }
</script>
